<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <base href="..">
    <title>Travel Slideshows Search</title>
    <link rel="stylesheet" href="css/slideshow.css">
    <script src="js/slideshow.js"></script>
    <script src="js/all_trips.js"></script>
    <script src="js/all_slides.js"></script>
    <script src="js/all_states.js"></script>
    <style media="screen">
      input, select {
        font-family: Arial;
        vertical-align: middle;
        height: 1.6em;
        box-sizing: content-box;
        box-shadow: 3px 3px 3px rgba(68, 68, 68, 0.5);
      }

      select {
        padding-inline-start: 1px;
        padding-inline-end: 1px;
        padding-top: 2px;
        padding-bottom: 2px;
      }

      /* Change padding on Firefox so select height same as input/button */
      @supports (-moz-appearance:none) {
        select {
          padding-top: 1px;
          padding-bottom: 1px;
        }
      }

      #searchBar {
        font-size: small;
        vertical-align: bottom;
      }

      #slideContent {
        color: #D2B48C;
        font-size: 2em;
        font-weight: bold;
      }
    </style>
    <script>
      // Maximum allowed search results
      var MAXIMUM_SEARCH_RESULT = 1500;

      // getSearchError returns user error, which is base[+text][+state]
      function getSearchError(base, state, text) {
        var msg = base;
        if (text != null) {
          msg = msg + " for text=\"" + text + "\"";
        }
        if (state != null) {
          msg = msg + " in state=\"" + state + "\"";
        }
        return msg;
      }

      // slideshowSearch runs slideshow based on filterd search results
      function slideshowSearch() {
        // Start with all available slides
        var filtered_slides = all_slides;

        // Filter slides based on state, if provided
        var state = null;
        var inputState = document.getElementById("inputState");
        if (inputState != null) {
          state = inputState.value;
          if (state != null && state.length > 0) {
            filtered_slides = filtered_slides.filter(slide => slide.state == state);
          } else {
            state = null;
          }
        }

        // Filter slides based on text, if provided ('!' as first character indicates negative search)
        var text = null;
        var invalidText = false;
        var inputText = document.getElementById("inputText");
        if (inputText != null) {
          text = inputText.value;
          if (text != null && text.trim().length > 0) {
            var cleanText = text.trim();

            // Valid characters are initial '!', letters, digits and whitespace
            if (!/^!?[0-9A-Za-z\s]+$/.test(cleanText)) {
              invalidText = true;
            } else {
              // Handle negative search if indicated
              var negativeSearch = false;
              if (cleanText.charAt(0) == '!') {
                cleanText = cleanText.substring(1);
                negativeSearch = true;
              }

              // Dynamically generate regex pattern for search
              var textWords = cleanText.split(/\s+/);
              var regexPattern = ".*";
              for (var i = 0; i < textWords.length; i++) {
                regexPattern += (textWords[i] + ".*");
              }

              // Perform case-insensitive search NOT including slide number
              var regexObj = new RegExp(regexPattern, 'i');
              if (negativeSearch) {
                filtered_slides = filtered_slides.filter(slide => !regexObj.test(slide.file.substring(4)));
              } else {
                filtered_slides = filtered_slides.filter(slide => regexObj.test(slide.file.substring(4)));
              }
            }
          } else {
            text = null;
          }
        }

        // Invalid search text, issue error
        if (invalidText) {
          alert("Invalid character in text=\"" + text + "\"");
        }

        // No search criteria, issue error
        else if (state == null && text == null) {
          alert(getSearchError("No search criteria", state, text));
        }

        // No search results, issue error
        else if (filtered_slides.length == 0) {
          alert(getSearchError("No search results", state, text));
        }

        // Too many search results, issue error
        else if (filtered_slides.length > MAXIMUM_SEARCH_RESULT) {
          alert(getSearchError("Too many search results (" + filtered_slides.length + ")", state, text));
        }

        // Search results just right, start slideshow
        else {
          var targetElement = document.getElementById("slideContent");

          // Clear out any existing slides in slideshow
          while (targetElement.firstChild != null) {
            targetElement.removeChild(targetElement.lastChild);
          }

          // Synchronously add title and preloaded slides to slideshow
          preloadSlideshow(targetElement, "SEARCH/title.jpg", filtered_slides);

          // Asynchronously add non-preloaded slides and credits to slideshow
          loadSlideshow(targetElement, filtered_slides);

          // Set number of slides in search results
          document.getElementById("searchResults").innerHTML = "&nbsp;<b>(" + filtered_slides.length + "/" + all_slides.length + " photos)</b>";

          // Initiate slideshow
          slideIndex = 0;
          if (MANUAL_SLIDESHOW) {
            hidePlayButton();
            showPic(1);
          } else {
            slideshow();
          }
        }
      }

      // verifySearchPrereqs runs slideshow if prerequisites (one valid query parameter) met
      function verifySearchPrereqs() {
        if ("URLSearchParams" in window) {
          var inputText = null;
          var inputState = null;
          var urlParams = new URLSearchParams(window.location.search);

          // Handle search text query parameter
          var urlParam = urlParams.get('text');
          if (urlParam != null) {
            if (/^!?[0-9A-Za-z\s]+$/.test(urlParam)) {
              inputText = urlParam;
            } else {
              alert("Invalid character in text=\"" + urlParam + "\", ignored");
              inputText = null;
            }
          }

          // Handle search state query parameter
          urlParam = urlParams.get('state');
          if (urlParam != null) {
            if (all_states.has(urlParam.toUpperCase()) ||
                all_states_canada.has(urlParam.toUpperCase()) ||
                all_states_other.has(urlParam.toUpperCase())) {
              inputState = urlParam.toUpperCase();
            } else {
              alert("Invalid state=\"" + urlParam + "\", ignored");
              inputState = null;
            }
          }

          // Run slideshow if at least one valid query parameter
          if (inputText != null || inputState != null) {
            if (inputText != null) {
              document.getElementById("inputText").value = inputText;
            }
            if (inputState != null) {
              document.getElementById("inputState").value = inputState;
            }
            slideshowSearch();
          }
        }
      }

      // addDropdownElementsFromMap is addDropdownElements worker
      function addDropdownElementsFromMap(mapStates, dropdownElem) {
        mapStates.forEach((value, key) => {
          var option = document.createElement('option');
          option.value = key;
          option.textContent = value.name;
          dropdownElem.appendChild(option);
        });
      }

      // addDropdownElements adds all map elements in js/all_states.js to dropdown menu
      function addDropdownElements(dropdownElem) {
        // Add US states
        addDropdownElementsFromMap(all_states, dropdownElem);

        // Add Canadian provinces
        var option = document.createElement('option');
        option.textContent = "Canada";
        option.disabled = true;
        dropdownElem.appendChild(option);
        addDropdownElementsFromMap(all_states_canada, dropdownElem);

        // Add other areas
        option = document.createElement('option');
        option.textContent = "Other";
        option.disabled = true;
        dropdownElem.appendChild(option);
        addDropdownElementsFromMap(all_states_other, dropdownElem);
      }
    </script>
  </head>
  <body>
    <table id="outerTable">
      <tr>
        <td>
          <span id="slideTitle">Travel Slideshows Search</span>
        </td>
      </tr>
      <tr>
        <td>
          <span id="searchBar">
            <input type="text" id="inputText" placeholder="Enter text" title="Search text">
            <select id="inputState" title="State list">
              <option value="">Select state</option>
            </select>
            <button onclick="slideshowSearch()" id="buttonSearch" title="Search">&#x1F50D;</button>
            <span id="searchResults"></span>
          </span>
        </td>
      </tr>
      <tr>
        <td>
          <table id="innerTable"><tr><td>
            <span id="slideContent">
              Please enter text and/or select state above, then click search button
            </span>
          </td></tr></table>
        </td>
      </tr>
      <tr>
        <td>
          <button onclick="changePic(-1)" id="buttonPrev" title="Previous slide"><b>&#10094;</b></button>
          <button onclick="toggleFlow(this)" id="buttonPlayPause" title="Pause">&#10074;&#10074;</button>
          <button onclick="changePic(1)" id="buttonNext" title="Next slide"><b>&#10095;</b></button>
        </td>
      </tr>
      <tr>
        <td>
          <span id="slideName">&nbsp;</span>
        </td>
      </tr>
    </table>
    <script>
      // Code is placed here so that the necessary elements (searchResults, inputText, etc.) have
      // been defined when it runs
      addDropdownElements(document.getElementById("inputState"));
      verifySearchPrereqs();
    </script>
  </body>
</html>
