<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <base href="..">
    <title>Travel Slideshows Query</title>
    <link rel="stylesheet" href="css/slideshow.css">
    <script src="js/slideshow.js"></script>
    <script src="js/all_trips.js"></script>
    <script src="js/all_slides.js"></script>
    <script src="js/all_states.js"></script>
    <style media="screen">
      #slideContent {
        color: #D2B48C;
        font-size: 2em;
        font-weight: bold;
      }

      #slideContent p {
        text-align: left;
        padding-left: 5px;
        padding-right: 5px;
      }

      #slideContent td {
        font-size: 0.6em;
        text-align: left;
        vertical-align: top;
        border-style: none;
        box-shadow: none;
        padding: 0px 1px 0px 1px;
      }
    </style>
    <script>
      // by-query.html is set up to run slideshows with pictures extracted from all_slides.js based
      // on query parameters, as opposed to those created statically in html files (i.e. a table of
      // '<img class="tripPix" ...>' elements.  This seems to run much faster (especially on GitHub
      // servers) and is much easier to maintain (just add new pictures to all_slides.js instead of
      // slideshow.html, compilation, state, favorites, etc.)
      //
      // Available query parameters to control filtering of pictures from all_slides.js:
      //   trip - matches "dir" key in all_slides object, i.e. "trip=1989Honeymoon"
      //   text - filters on "file" key in all_slides object, i.e. "text=state park"
      //   state - matches "state" key in all_slides object, i.e. "state=TX"
      //   attrs - filters on "attrs" key in all_slides object, i.e. "attrs=west fave"
      //
      // The attrs parameter has the following format:
      //   [region] [compilation] [fave] [other]... [mode]
      // where:
      //   region = east|overseas|rockies|west
      //   compilation = grtlks|washdc
      //   mode = air|rail|road|water

      var validAttrs = [
        "east", "overseas", "rockies", "west", // region - GitHub repo (choose at most one)
        "grtlks", "washdc",                    // compilation - regional compilation (choose at most one)
        "fave",                                // Dave's fave!
        "air", "rail", "road", "water",        // mode -  transportation mode when picture taken (choose at most one)
                                               // other - one or more of the following:
        "animal",   // mammals, birds, insects, etc.
        "backlit",  // backlit
        "barn",     // barns
        "beam",     // sunbeams
        "boat",     // boats
        "fall",     // Autumn colors
        "church",   // churches
        "cloud",    // clouds not already in "sun" or "storm"
        "flower",   // flowers
        "fog",      // fog
        "frame",    // framed
        "moon",     // moon
        "night",    // nighttime/sundown time exposure
        "plane",    // airplanes
        "rainbow",  // rainbows
        "reflect",  // reflections
        "shadow",   // shadows
        "smoke",    // smoke
        "storm",    // rain, lightning, funnels, etc.
        "sun",      // sunrise or sunset
        "track",    // train tracks
        "time",     // daytime/sunup time expsoure
        "train",    // trains
        "whirl",    // dust devils, funnels
        "wind",     // windmills, windpumps, windfarms
      ];

      var queryHelp = '<p align=left>Please type one or more of the following query parameters (as key-value pairs) in address bar above, then press enter:'+
                      '<table>'+
                      '<tr><td>trip</td><td>Name of trip, e.g. "trip=2014Trip" (case-sensitive)</td></tr>'+
                      '<tr><td>text</td><td>Search text, e.g. "text=state park"</td></tr>'+
                      '<tr><td>state&nbsp;&nbsp;</td><td>State abbreviation, e.g. "state=AZ"</td></tr>'+
                      '<tr><td>attrs</td><td>Attribute(s) - ' + validAttrs.join(", ") + ', e.g. "attrs=rockies animal"</td></tr>'+
                      '<tr><td></td><td><br>For example, to see a slideshow of animals in Utah\'s "Mighty 5" national parks:<br>&nbsp;&nbsp;"/by-query.html?text=national park&state=UT&attrs=animal"</td></tr>'+
                      '</table>'
                      '</p>';

      // slideshowQuery runs slideshow based on filterd search results obtained from query parameters
      function slideshowQuery(trip, text, state, attrs, titleText, titleSlide) {
        // Start with all available slides
        var filtered_slides = all_slides;

        // SPECIAL CASE: GitHub
        if (titleSlide != null && titleSlide.startsWith('MULTIYR')) {
          titleSlide = "https://deblaschke.github.io/travel-slideshows/" + titleSlide;
        }

        // Filter slides based on trip, if provided
        if (trip != null && trip.length > 0) {
          filtered_slides = filtered_slides.filter(slide => slide.dir == trip);

          // Provide title info if none yet provided
          if (titleText == null && titleSlide == null && all_trips.has(trip)) {
            titleText = all_trips.get(trip).title;
            titleSlide = getRegion(trip) + "/" + trip + "/title.jpg";
          }
        }

        // Filter slides based on state, if provided
        if (state != null && state.length > 0) {
          filtered_slides = filtered_slides.filter(slide => slide.state == state);

          // Provide title info if none yet provided
          if (titleText == null && titleSlide == null && all_states.has(state)) {
              titleText = all_states.get(state).name;
              titleSlide = "STATES/title_" + state + ".jpg";
          }
        }

        // Filter slides based on attributes, if provided
        if (attrs != null && attrs.length > 0) {
          var attrWords = attrs.trim().split(/\s+/);
          for (var i = 0; i < attrWords.length; i++) {
            filtered_slides = filtered_slides.filter(slide => slide.attrs.includes(attrWords[i]));
          }
        }

        // Filter slides based on text, if provided ('!' as first character indicates negative search)
        if (text != null && text.length > 0) {
          var cleanText = text.trim();

          // Handle negative search if indicated
          var negativeSearch = false;
          if (cleanText.charAt(0) == '!') {
            cleanText = cleanText.substring(1);
            negativeSearch = true;
          }

          // Dynamically generate regex pattern for search
          var textWords = cleanText.split(/\s+/);
          var regexPattern = ".*";
          for (var i = 0; i < textWords.length; i++) {
            regexPattern += (textWords[i] + ".*");
          }

          // Perform case-insensitive search NOT including slide number
          var regexObj = new RegExp(regexPattern, 'i');
          if (negativeSearch) {
            filtered_slides = filtered_slides.filter(slide => !regexObj.test(slide.file.substring(4)));
          } else {
            filtered_slides = filtered_slides.filter(slide => regexObj.test(slide.file.substring(4)));
          }
        }

        // DEBUG> Display number of filtered slides
        // console.log("There are " + filtered_slides.length + " pictures in this slideshow");

        var targetElement = document.getElementById("slideContent");

        // Clear out any existing slides in slideshow
        while (targetElement.firstChild != null) {
          targetElement.removeChild(targetElement.lastChild);
        }

        // Set slide title if one exists
        if (titleText == null) {
          titleText = "Travel Slideshows Query";
        }
        document.title = titleText;
        document.getElementById("slideTitle").innerHTML = titleText;

        // No query results, issue error
        if (filtered_slides.length == 0) {
          alert("No query results");
          targetElement.innerHTML = queryHelp;
        }

        // Query results just right, start slideshow
        else {
          // Synchronously add title and preloaded slides to slideshow
          preloadSlideshow(targetElement, titleSlide, filtered_slides);

          // Asynchronously add non-preloaded slides and credits to slideshow
          loadSlideshow(targetElement, filtered_slides);

          // Initiate slideshow
          slideIndex = 0;
          if (MANUAL_SLIDESHOW) {
            hidePlayButton();
            showPic(1);
          } else {
            slideshow();
          }
        }
      }

      // verifyQueryPrereqs runs slideshow if prerequisites (one valid query parameter) met
      function verifyQueryPrereqs() {
        if ("URLSearchParams" in window) {
          var inputTrip = null;
          var inputText = null;
          var inputState = null;
          var inputAttrs = null;
          var inputTitleText = null;
          var inputTitleSlide = null;
          var urlParams = new URLSearchParams(window.location.search);

          // Handle search trip query parameter
          var urlParam = urlParams.get('trip');
          if (urlParam != null) {
            if (all_trips.has(urlParam)) {
              inputTrip = urlParam;
            } else {
              alert("Invalid trip=\"" + urlParam + "\", ignored");
              inputTrip = null;
            }
          }

          // Handle search text query parameter
          urlParam = urlParams.get('text');
          if (urlParam != null) {
            if (/^!?[0-9A-Za-z\s]+$/.test(urlParam)) {
              inputText = urlParam;
            } else {
              alert("Invalid character in text=\"" + urlParam + "\", ignored");
              inputText = null;
            }
          }

          // Handle search state query parameter
          urlParam = urlParams.get('state');
          if (urlParam != null) {
            if (all_states.has(urlParam.toUpperCase()) ||
                all_states_canada.has(urlParam.toUpperCase()) ||
                all_states_other.has(urlParam.toUpperCase())) {
              inputState = urlParam.toUpperCase();
            } else {
              alert("Invalid state=\"" + urlParam + "\", ignored");
              inputState = null;
            }
          }

          // Handle search attributes query parameter
          urlParam = urlParams.get('attrs');
          if (urlParam != null) {
            if (/^[A-Za-z\s]+$/.test(urlParam)) {
              var words = urlParam.trim().split(/\s+/);
              var validWords = "";
              for (var i = 0; i < words.length; i++) {
                if (!validAttrs.includes(words[i])) {
                  alert("Invalid attribute in attrs=\"" + words[i] + "\", ignored; valid attributes are " + validAttrs.join(", "));
                } else {
                  validWords += words[i] + " ";
                }
              }

              if (validWords.length == 0) {
                inputAttrs = null;
              } else {
                inputAttrs = validWords;
              }
            } else {
              alert("Invalid character in attrs=\"" + urlParam + "\", ignored");
              inputAttrs = null;
            }
          }

          // Handle undocumented compilations query parameter
          urlParam = urlParams.get('comp');
          if (urlParam != null) {
            switch (urlParam) {
              case 'fave':
                inputAttrs = "fave";
                urlParams.set("titleText", "Dave's Faves");
                urlParams.set("titleSlide", "MULTIYR/title_faves.jpg");
                break;
              case 'germany':
                inputState = "DEU";
                urlParams.set("titleText", "Germany");
                urlParams.set("titleSlide", "MULTIYR/title_germany.jpg");
                break;
              case 'glacier':
                inputText = "Glacier National Park";
                inputState = "MT";
                urlParams.set("titleText", "Glacier National Park");
                urlParams.set("titleSlide", "MULTIYR/title_glacier.jpg");
                break;
              case 'grtlks':
                inputAttrs = "grtlks";
                urlParams.set("titleText", "Great Lakes Region");
                urlParams.set("titleSlide", "MULTIYR/title_greatlakes.jpg");
                break;
              case 'mighty5':
                inputText = "National Park";
                inputState = "UT";
                urlParams.set("titleText", "Utah's Mighty 5");
                urlParams.set("titleSlide", "MULTIYR/title_mighty5.jpg");
                break;
              case 'washdc':
                inputAttrs = "washdc";
                urlParams.set("titleText", "Washington, D.C. Area");
                urlParams.set("titleSlide", "MULTIYR/title_washingtondc.jpg");
                break;
              case 'yellowstone':
                inputText = "Yellowstone National Park";
                urlParams.set("titleText", "Yellowstone National Park");
                urlParams.set("titleSlide", "MULTIYR/title_yellowstone.jpg");
                break;
              case 'yosemite':
                inputText = "Yosemite National Park";
                urlParams.set("titleText", "Yosemite National Park");
                urlParams.set("titleSlide", "MULTIYR/title_yosemite.jpg");
                break;
              default:
                alert("Invalid comp=\"" + urlParam + "\", ignored");
                break;
            }
          }

          // Silently disable from/to query parameters if trip not specified
          if (inputTrip == null && (SLIDESHOW_INDEX_FROM != -1 || SLIDESHOW_INDEX_TO != -1)) {
            SLIDESHOW_INDEX_FROM = -1;
            SLIDESHOW_INDEX_TO = -1;
          }

          // Run slideshow if at least one valid query parameter
          if (inputTrip != null || inputText != null || inputState != null || inputAttrs != null) {
            slideshowQuery(inputTrip, inputText, inputState, inputAttrs, urlParams.get("titleText"), urlParams.get("titleSlide"));
          } else {
            document.getElementById("slideContent").innerHTML = queryHelp;
          }
        }
      }
    </script>
  </head>
  <body>
    <table id="outerTable">
      <tr>
        <td>
          <span id="slideTitle">Travel Slideshows Query</span>
        </td>
      </tr>
      <tr>
        <td>
          <table id="innerTable"><tr><td>
            <span id="slideContent"></span>
          </td></tr></table>
        </td>
      </tr>
      <tr>
        <td>
          <button onclick="changePic(-1)" id="buttonPrev" title="Previous slide"><b>&#10094;</b></button>
          <button onclick="toggleFlow(this)" id="buttonPlayPause" title="Pause">&#10074;&#10074;</button>
          <button onclick="changePic(1)" id="buttonNext" title="Next slide"><b>&#10095;</b></button>
        </td>
      </tr>
      <tr>
        <td>
          <span id="slideName">&nbsp;</span>
        </td>
      </tr>
    </table>
    <script>
      // Code is placed here so that the necessary elements (slideTitle, slideContent, etc.) have
      // been defined when it runs
      verifyQueryPrereqs();
    </script>
  </body>
</html>
